# SCC Verifier MultiApi Converter


## üìú Summary:

SCC Verifier MultiApi Converter allows us to use Spring Cloud Contract to generate contracts from an OpenApi yaml document or an AsyncApi document. This plugin will detect automatically what contract needs to be generated

Here is the documentation for these technologies:

- [Spring Cloud Contract](https://cloud.spring.io/spring-cloud-contract/reference/html/)

- [OpenApi](https://swagger.io/specification/)

- [AsyncApi](https://www.asyncapi.com/docs/getting-started)


## üöÄ Getting Started

In order to get this plugin working, you need the following things installed in your computer:

- Java 11 Version
- Maven

After you have these installed, you need to add the Spring Cloud Contract Maven Plugin in your pom.xml file and extend it with this Converter as a Dependency. Here is an easy example of a basic configuration:

```xml
<plugin>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-contract-maven-plugin</artifactId>
  <version>3.0.0</version>
  <extensions>true</extensions>
  <configuration>
    <packageWithBaseClasses>com.corunet.challenge.gameserver.baseclasses</packageWithBaseClasses>
    <contractsDirectory>${project.basedir}/src/main/resources/api</contractsDirectory>
  </configuration>
  <dependencies>
    <dependency>
      <groupId>com.corunet</groupId>
      <artifactId>scc-multiapi-converter</artifactId>
      <version>1.1.0-SNAPSHOT</version>
      <scope>compile</scope>
    </dependency>
  </dependencies>
</plugin>
```
## üßëüèª‚Äçüíª Usage

Inside the configuration tag, you must declare the **contractsDirectory** tag. In this tag you must specify the directory that contains the OpenApi/AsyncApi Yamls.

Also, we recommend specifying the **baseClassForTests** tag. This tag indicates the base class from which the autogenerated test will be extended. This class must be a test class of the producer part in which only a call to the producer method will be made, which is necessary for the test of the producer of the autogenerated class.

Once you specify this in your pom.xml you must use the command: **maven** **clean** **install**. This will generate the stubs necessary for the contract testing generation under the stubs folder.

It will also generate the ContractVerifierTest class for the producer and consumer tests for your Messaging Api and your Rest Api, in addition to the corresponding yml files with the contracts of both, inside target in the package where your baseClassForTests is located. If you want to change where your contracts will be located you must use the basePackageForTests tag in the pom.xml.

If you need more control over the settings of your project, you can use all the Configuration Options that Spring Cloud Contract Maven Plugin has. These configuration options can be checked in the official documentation webpage under 4.2.7 Section: [Spring Cloud Contract Verifier Setup](https://cloud.spring.io/spring-cloud-contract/2.0.x/multi/multi__spring_cloud_contract_verifier_setup.html#maven-configuration-options).

## ‚úèÔ∏è Writing Ymls:

This plugin supports most of the OpenApi/Swagger and AsyncApi, but there are a couple of things that must be noted:

- Using **OpenApi/AsyncApi¬¥s example label** in the parameters/schemas will check in our contracts that the response is equal to the example value instead of using a Regex.

- Please be aware that writing an example must be the same type as indicated in the file, otherwise your contract will break.

This is an easy example of a small YAML for OpenApi that will work with our plugin:

```yaml
openapi: "3.0.0"
info:
  version: 1.0.0
  title: Corunet Challenge Game Server
  license:
    name: MIT
servers:
- url: http://localhost:8080/v1
paths:
  /games:
    post:
      summary: Start a Game
      operationId: createGame
      tags:
      - games
      responses:
        '200':
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    $ref: "#/components/schemas/Message"
components:
  schemas:
    Message:
      type: object
      properties:
        description:
          type: string
```

And here, there is an example of a YAML file for the AsyncApi side:

```yaml
asyncapi: 2.3.0
info:
  title: Order Service
  version: 1.0.0
  description: Order management Service
channels:
  orderCreated:
    publish:
      operationId: "publishOperation"
      message:
        $ref: '#/components/messages/OrderCreated'
  createOrder:
    subscribe:
      operationId: "subscribeOperation"
      message:
        $ref: '#/components/messages/CreateOrder'
components:
  messages:
    OrderCreated:
      payload:
        $ref: '#/components/schemas/Order'
    CreateOrder:
      payload:
        $ref: '#/components/schemas/Order'
  schemas:
    Order:
      type: object
      properties:
        tableNumber:
          type: integer
          format: int32
          example: 1
        clientRef:
          type: integer
          format: int32
          example: 432

```

## ‚ö†Ô∏èCurrent Limitations:

Currently, this plugin has some limitations that will be addressed in the future. In order to make it work, we must follow some rules:

**OpenApi implementation**:

- This plugin allows the use of AllOfs and AnyOfs in the Response section. However, OpenApi does not support AllOfs in this section and AnyOf usage might not work depending on the OpenApi version you are using.
- Some OpenApi functionalities are not implemented yet, such as creating example objects, instead you must use the example tag in every property of the object.


**Async Api implementation**:

- This plugin doesn't allow the use of AllOfs, OneOfs and AnyOfs.
- Support for generating contracts from avro files.
- Some AsyncApi functionalities are not implemented yet, such as creating example objects, instead you must use the example tag in every property of the object.

## üåê RoadMap:

- Add implementation to support AllOfs, AnyOfs and OneOfs in AsyncApi.
- Add support for generating contracts from avro files.
- Further investigation for OpenApi/AsyncApi and Spring Cloud Contract possibilities.
- More testing and fixing possible bugs that may occur in the future.